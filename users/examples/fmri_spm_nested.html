
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Neuroimaging in Python - Pipelines and Interfaces &#8212; nipy pipeline and interfaces package</title>
    <link rel="stylesheet" href="../../_static/nipype.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
 
<meta name="keywords" content="nipype, neuroimaging, pipeline, workflow, parallel, python, neuroscience">
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-339450-7', 'nipy.org/nipype');
  ga('send', 'pageview');
</script>
<script>
  ((window.gitter = {}).chat = {}).options = {
    room: 'nipy/nipype'
  };
</script>
<script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>

  </head><body>
<div class="header-wrapper">
    <div style="background-color: white; text-align: left; padding: 10px 10px 15px 15px">
            <a href="../../index.html">
            <img src="../../_static/nipype-banner-bg.png" alt="NIPY logo"  border="0" />
        <div style="margin-top: 1em;
                border-top: 1px solid #AAA;
                border-bottom: 1px solid #AAA;
                border-radius: 5px;
                padding: 3px 1em;">
            <link rel="stylesheet" href="http://www.google.com/cse/style/look/default.css" type="text/css" />
<style type="text/css">
    a.navbar {
    color: ;
    letter-spacing: .05em;
    font-weight: bold;
        }
</style>

<a class="navbar" href="../../index.html">Home</a> ·
<a class="navbar" href="../../quickstart.html">Quickstart</a> ·
<a class="navbar" href="../../documentation.html">Documentation</a> ·
<a class="navbar" href="../../about.html">About</a> ·
<a class="navbar" href="http://nipy.org">Nipy</a>

        </div>
    </div>
</div>

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<style type="text/css">
    input.gsc-input {
        border-color: #BCCDF0;
    }
    input.gsc-search-button {
        border-color: #666666;
        background-color: #CECECE;
        padding: 0;
    }
    div.sphinxsidebar .tile {
        border: 1px solid #D1DDE2;
        border-radius: 10px;
        background-color: #E1E8EC;
        padding-left: 0.5em;
        margin: 1em 0;
    }
    div.sphinxsidebar input[type="text"] {
        width: 100%;
    }
    div.sphinxsidebar input[type="submit"] {
        width: 100%;
    }
</style>

<div class="sidebarblock">
    <script>
      (function() {
        var cx = '010960497803984932957:u8pmqf7fdoq';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:search></gcse:search>
</div>

  <h3><a href="../../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">fMRI: SPM nested workflows</a><ul>
<li><a class="reference internal" href="#preliminaries">Preliminaries</a></li>
<li><a class="reference internal" href="#lows">lows</a></li>
<li><a class="reference internal" href="#set-up-preprocessing-workflow">Set-up preprocessing workflow</a></li>
<li><a class="reference internal" href="#set-up-analysis-workflow">Set up analysis workflow</a></li>
<li><a class="reference internal" href="#preproc-analysis-pipeline">Preproc + Analysis pipeline</a></li>
<li><a class="reference internal" href="#data-specific-components">Data specific components</a></li>
<li><a class="reference internal" href="#experimental-paradigm-specific-components">Experimental paradigm specific components</a></li>
<li><a class="reference internal" href="#setup-storage-results">Setup storage results</a></li>
<li><a class="reference internal" href="#setup-level-2-pipeline">Setup level 2 pipeline</a></li>
<li><a class="reference internal" href="#execute-the-second-level-pipeline">Execute the second level pipeline</a></li>
</ul>
</li>
</ul>

<style type="text/css">
    div.sphinxsidebar .tile {
        border: 1px solid #D1DDE2;
        border-radius: 10px;
        background-color: #E1E8EC;
        padding-left: 0.5em;
        margin: 1em 0;
    }
</style>
<div class="sidebarblock">
    <h3>Versions</h3>

    <div class="tile">
        <table style="width: 100%;">
            <tr style="font-weight: bold;">
                <td align="left">Release</td><td align="right">Devel</td>
            </tr>
            <tr>
                <td align="left">1.1.3</td><td align="right">1.1.4-dev+g93c475b</td>
            </tr>
            <tr>
                <td align="left"><a href="../install.html">Download</a></td>
                <td align="right"><a href="https://github.com/nipy/nipype">Github</a></td>
            </tr>
        </table>
    </div>
</div>


<script type="text/javascript">
    (function() {
        var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
        po.src = 'https://apis.google.com/js/plusone.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
    })();
</script>

<h3>Links</h3>

<ul>
    <li>Docs: <a href="http://nipy.org/nipype">Stable</a> · <a href="http://nipype.readthedocs.org/en/latest/">Dev</a></li>
    <li>Code: <a href="http://github.com/nipy/nipype">Github</a> · <a href="http://github.com/nipy/nipype/issues">Bugs-Requests</a></li>
    <li>Forum: <a href="https://neurostars.org/search?q=nipype">User</a> · <a href="https://mail.python.org/mailman/listinfo/neuroimaging">Developer</a></li>
    <li>Chat: <a href="https://gitter.im/nipy/nipype">Gitter</a> · <a href="https://brainhack.slack.com/messages/C1FR76RAL">Slack</a></li>
    <li><a href="about.html#funding">Funding</a> · <a href="http://nipy.org/software/license/index.html"><img src="https://img.shields.io/pypi/l/nipype.svg" alt="License"></a></li>
    <li><a href="https://travis-ci.org/nipy/nipype"><img src="https://travis-ci.org/nipy/nipype.png?branch=master" alt="travis"></a> · <a href='https://codecov.io/gh/nipy/nipype'><img src='https://codecov.io/gh/nipy/nipype/branch/master/graph/badge.svg' alt='Coverage Status' /></a></li>
    <a href='https://pypi.python.org/pypi/nipype/'><img src='https://img.shields.io/pypi/pyversions/nipype.svg' alt='Python Versions' /></a></li>
</ul>

 
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="fmri-spm-nested-workflows">
<span id="example-fmri-spm-nested"></span><h1>fMRI: SPM nested workflows<a class="headerlink" href="#fmri-spm-nested-workflows" title="Permalink to this headline">¶</a></h1>
<p>The fmri_spm.py integrates several interfaces to perform a first
and second level analysis on a two-subject data set.  The tutorial can
be found in the examples folder.  Run the tutorial from inside the
nipype tutorial directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">fmri_spm_nested</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>Import necessary modules from nipype.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="k">import</span> <span class="nb">str</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="k">import</span> <span class="nb">range</span>
<span class="kn">import</span> <span class="nn">os.path</span> <span class="k">as</span> <span class="nn">op</span>  <span class="c1"># system functions</span>

<span class="kn">from</span> <span class="nn">nipype.interfaces</span> <span class="k">import</span> <span class="n">io</span> <span class="k">as</span> <span class="n">nio</span>  <span class="c1"># Data i/o</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces</span> <span class="k">import</span> <span class="n">spm</span> <span class="k">as</span> <span class="n">spm</span>  <span class="c1"># spm</span>
<span class="c1"># from nipype.interfaces import matlab as mlab    # how to run matlab</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces</span> <span class="k">import</span> <span class="n">fsl</span> <span class="k">as</span> <span class="n">fsl</span>  <span class="c1"># fsl</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces</span> <span class="k">import</span> <span class="n">utility</span> <span class="k">as</span> <span class="n">niu</span>  <span class="c1"># utility</span>
<span class="kn">from</span> <span class="nn">nipype.pipeline</span> <span class="k">import</span> <span class="n">engine</span> <span class="k">as</span> <span class="n">pe</span>  <span class="c1"># pypeline engine</span>
<span class="kn">from</span> <span class="nn">nipype.algorithms</span> <span class="k">import</span> <span class="n">rapidart</span> <span class="k">as</span> <span class="n">ra</span>  <span class="c1"># artifact detection</span>
<span class="kn">from</span> <span class="nn">nipype.algorithms</span> <span class="k">import</span> <span class="n">modelgen</span> <span class="k">as</span> <span class="n">model</span>  <span class="c1"># model specification</span>
</pre></div>
</div>
<div class="section" id="preliminaries">
<h2>Preliminaries<a class="headerlink" href="#preliminaries" title="Permalink to this headline">¶</a></h2>
<p>Set any package specific configuration. The output file format
for FSL routines is being set to uncompressed NIFTI and a specific
version of matlab is being used. The uncompressed format is required
because SPM does not handle compressed NIFTI.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Tell fsl to generate all output in uncompressed nifti format</span>
<span class="n">fsl</span><span class="o">.</span><span class="n">FSLCommand</span><span class="o">.</span><span class="n">set_default_output_type</span><span class="p">(</span><span class="s1">&#39;NIFTI&#39;</span><span class="p">)</span>

<span class="c1"># Set the way matlab should be called</span>
<span class="c1"># mlab.MatlabCommand.set_default_matlab_cmd(&quot;matlab -nodesktop -nosplash&quot;)</span>
<span class="c1"># mlab.MatlabCommand.set_default_paths(&#39;/software/spm8&#39;)</span>
</pre></div>
</div>
</div>
<div class="section" id="lows">
<h2>lows<a class="headerlink" href="#lows" title="Permalink to this headline">¶</a></h2>
<p>In this tutorial we will be setting up a hierarchical workflow for spm
analysis. This will demonstrate how pre-defined workflows can be setup
and shared across users, projects and labs.
Example of how to inline functions in connect()
———————————————–</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_template_path</span><span class="p">(</span><span class="n">in_data</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">os.path</span> <span class="k">as</span> <span class="nn">op</span>
    <span class="k">return</span> <span class="n">op</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">in_data</span><span class="p">,</span> <span class="s1">&#39;nipype-tutorial/data/T1.nii&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="set-up-preprocessing-workflow">
<h2>Set-up preprocessing workflow<a class="headerlink" href="#set-up-preprocessing-workflow" title="Permalink to this headline">¶</a></h2>
<p>This is a generic preprocessing workflow that can be used by different analyses</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">preproc</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;preproc&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>A node called <code class="code docutils literal notranslate"><span class="pre">inputnode</span></code> is set to designate the path in which input data
are located:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">inputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
    <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_data&#39;</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;inputnode&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Use <code class="xref py py-class docutils literal notranslate"><span class="pre">nipype.interfaces.spm.Realign</span></code> for motion correction
and register all images to the mean image.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">realign</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">spm</span><span class="o">.</span><span class="n">Realign</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;realign&quot;</span><span class="p">)</span>
<span class="n">realign</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">register_to_mean</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
<p>Use <code class="xref py py-class docutils literal notranslate"><span class="pre">nipype.algorithms.rapidart</span></code> to determine which of the
images in the functional series are outliers based on deviations in
intensity or movement.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">art</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">ra</span><span class="o">.</span><span class="n">ArtifactDetect</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;art&quot;</span><span class="p">)</span>
<span class="n">art</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">use_differences</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
<span class="n">art</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">use_norm</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">art</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">norm_threshold</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">art</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">zintensity_threshold</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">art</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">mask_type</span> <span class="o">=</span> <span class="s1">&#39;file&#39;</span>
<span class="n">art</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">parameter_source</span> <span class="o">=</span> <span class="s1">&#39;SPM&#39;</span>
</pre></div>
</div>
<p>Skull strip structural images using
<code class="xref py py-class docutils literal notranslate"><span class="pre">nipype.interfaces.fsl.BET</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">skullstrip</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">fsl</span><span class="o">.</span><span class="n">BET</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;skullstrip&quot;</span><span class="p">)</span>
<span class="n">skullstrip</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
<p>Use <code class="xref py py-class docutils literal notranslate"><span class="pre">nipype.interfaces.spm.Coregister</span></code> to perform a rigid
body registration of the functional data to the structural data.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">coregister</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">spm</span><span class="o">.</span><span class="n">Coregister</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;coregister&quot;</span><span class="p">)</span>
<span class="n">coregister</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">jobtype</span> <span class="o">=</span> <span class="s1">&#39;estimate&#39;</span>
</pre></div>
</div>
<p>Warp functional and structural data to SPM’s T1 template using
<code class="xref py py-class docutils literal notranslate"><span class="pre">nipype.interfaces.spm.Normalize</span></code>.  The tutorial data set
includes the template image, T1.nii.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">normalize</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">spm</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;normalize&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Smooth the functional data using
<code class="xref py py-class docutils literal notranslate"><span class="pre">nipype.interfaces.spm.Smooth</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">smooth</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">spm</span><span class="o">.</span><span class="n">Smooth</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;smooth&quot;</span><span class="p">)</span>
<span class="n">fwhmlist</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<span class="n">smooth</span><span class="o">.</span><span class="n">iterables</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;fwhm&#39;</span><span class="p">,</span> <span class="n">fwhmlist</span><span class="p">)</span>

<span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
    <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">normalize</span><span class="p">,</span> <span class="p">[((</span><span class="s1">&#39;in_data&#39;</span><span class="p">,</span> <span class="n">_template_path</span><span class="p">),</span> <span class="s1">&#39;template&#39;</span><span class="p">)]),</span>
    <span class="p">(</span><span class="n">realign</span><span class="p">,</span> <span class="n">coregister</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;mean_image&#39;</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;realigned_files&#39;</span><span class="p">,</span>
                                                      <span class="s1">&#39;apply_to_files&#39;</span><span class="p">)]),</span>
    <span class="p">(</span><span class="n">coregister</span><span class="p">,</span> <span class="n">normalize</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;coregistered_files&#39;</span><span class="p">,</span> <span class="s1">&#39;apply_to_files&#39;</span><span class="p">)]),</span>
    <span class="p">(</span><span class="n">normalize</span><span class="p">,</span> <span class="n">smooth</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;normalized_files&#39;</span><span class="p">,</span> <span class="s1">&#39;in_files&#39;</span><span class="p">)]),</span>
    <span class="p">(</span><span class="n">normalize</span><span class="p">,</span> <span class="n">skullstrip</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;normalized_source&#39;</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)]),</span>
    <span class="p">(</span><span class="n">realign</span><span class="p">,</span> <span class="n">art</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;realignment_parameters&#39;</span><span class="p">,</span> <span class="s1">&#39;realignment_parameters&#39;</span><span class="p">)]),</span>
    <span class="p">(</span><span class="n">normalize</span><span class="p">,</span> <span class="n">art</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;normalized_files&#39;</span><span class="p">,</span> <span class="s1">&#39;realigned_files&#39;</span><span class="p">)]),</span>
    <span class="p">(</span><span class="n">skullstrip</span><span class="p">,</span> <span class="n">art</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;mask_file&#39;</span><span class="p">,</span> <span class="s1">&#39;mask_file&#39;</span><span class="p">)]),</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
<div class="section" id="set-up-analysis-workflow">
<h2>Set up analysis workflow<a class="headerlink" href="#set-up-analysis-workflow" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">l1analysis</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;analysis&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Generate SPM-specific design information using
<code class="xref py py-class docutils literal notranslate"><span class="pre">nipype.interfaces.spm.SpecifyModel</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">modelspec</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">SpecifySPMModel</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;modelspec&quot;</span><span class="p">)</span>
<span class="n">modelspec</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">concatenate_runs</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
<p>Generate a first level SPM.mat file for analysis
<code class="xref py py-class docutils literal notranslate"><span class="pre">nipype.interfaces.spm.Level1Design</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">level1design</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">spm</span><span class="o">.</span><span class="n">Level1Design</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;level1design&quot;</span><span class="p">)</span>
<span class="n">level1design</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">bases</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;hrf&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;derivs&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]}}</span>
</pre></div>
</div>
<p>Use <code class="xref py py-class docutils literal notranslate"><span class="pre">nipype.interfaces.spm.EstimateModel</span></code> to determine the
parameters of the model.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">level1estimate</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">spm</span><span class="o">.</span><span class="n">EstimateModel</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;level1estimate&quot;</span><span class="p">)</span>
<span class="n">level1estimate</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">estimation_method</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Classical&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
</pre></div>
</div>
<p>Use <code class="xref py py-class docutils literal notranslate"><span class="pre">nipype.interfaces.spm.EstimateContrast</span></code> to estimate the
first level contrasts specified in a few steps above.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">contrastestimate</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">spm</span><span class="o">.</span><span class="n">EstimateContrast</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;contrastestimate&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Use :class: <cite>nipype.interfaces.utility.Select</cite> to select each contrast for
reporting.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">selectcontrast</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">niu</span><span class="o">.</span><span class="n">Select</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;selectcontrast&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Use <code class="xref py py-class docutils literal notranslate"><span class="pre">nipype.interfaces.fsl.Overlay</span></code> to combine the statistical output of
the contrast estimate and a background image into one volume.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">overlaystats</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">fsl</span><span class="o">.</span><span class="n">Overlay</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;overlaystats&quot;</span><span class="p">)</span>
<span class="n">overlaystats</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">stat_thresh</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">overlaystats</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">show_negative_stats</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">overlaystats</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">auto_thresh_bg</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
<p>Use <code class="xref py py-class docutils literal notranslate"><span class="pre">nipype.interfaces.fsl.Slicer</span></code> to create images of the overlaid
statistical volumes for a report of the first-level results.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">slicestats</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">fsl</span><span class="o">.</span><span class="n">Slicer</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;slicestats&quot;</span><span class="p">)</span>
<span class="n">slicestats</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">all_axial</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">slicestats</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">image_width</span> <span class="o">=</span> <span class="mi">750</span>

<span class="n">l1analysis</span><span class="o">.</span><span class="n">connect</span><span class="p">([(</span><span class="n">modelspec</span><span class="p">,</span> <span class="n">level1design</span><span class="p">,</span>
                     <span class="p">[(</span><span class="s1">&#39;session_info&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;session_info&#39;</span><span class="p">)]),</span> <span class="p">(</span><span class="n">level1design</span><span class="p">,</span> <span class="n">level1estimate</span><span class="p">,</span>
                                           <span class="p">[(</span><span class="s1">&#39;spm_mat_file&#39;</span><span class="p">,</span> <span class="s1">&#39;spm_mat_file&#39;</span><span class="p">)]),</span>
                    <span class="p">(</span><span class="n">level1estimate</span><span class="p">,</span> <span class="n">contrastestimate</span><span class="p">,</span>
                     <span class="p">[(</span><span class="s1">&#39;spm_mat_file&#39;</span><span class="p">,</span> <span class="s1">&#39;spm_mat_file&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;beta_images&#39;</span><span class="p">,</span>
                                                         <span class="s1">&#39;beta_images&#39;</span><span class="p">),</span>
                      <span class="p">(</span><span class="s1">&#39;residual_image&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;residual_image&#39;</span><span class="p">)]),</span> <span class="p">(</span><span class="n">contrastestimate</span><span class="p">,</span> <span class="n">selectcontrast</span><span class="p">,</span>
                                             <span class="p">[(</span><span class="s1">&#39;spmT_images&#39;</span><span class="p">,</span> <span class="s1">&#39;inlist&#39;</span><span class="p">)]),</span>
                    <span class="p">(</span><span class="n">selectcontrast</span><span class="p">,</span> <span class="n">overlaystats</span><span class="p">,</span>
                     <span class="p">[(</span><span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="s1">&#39;stat_image&#39;</span><span class="p">)]),</span> <span class="p">(</span><span class="n">overlaystats</span><span class="p">,</span> <span class="n">slicestats</span><span class="p">,</span>
                                                <span class="p">[(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)])])</span>
</pre></div>
</div>
</div>
<div class="section" id="preproc-analysis-pipeline">
<h2>Preproc + Analysis pipeline<a class="headerlink" href="#preproc-analysis-pipeline" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">l1pipeline</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;firstlevel&#39;</span><span class="p">)</span>
<span class="n">l1pipeline</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
    <span class="p">(</span><span class="n">preproc</span><span class="p">,</span> <span class="n">l1analysis</span><span class="p">,</span>
     <span class="p">[(</span><span class="s1">&#39;realign.realignment_parameters&#39;</span><span class="p">,</span> <span class="s1">&#39;modelspec.realignment_parameters&#39;</span><span class="p">),</span>
      <span class="p">(</span><span class="s1">&#39;smooth.smoothed_files&#39;</span><span class="p">,</span>
       <span class="s1">&#39;modelspec.functional_runs&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;art.outlier_files&#39;</span><span class="p">,</span>
                                      <span class="s1">&#39;modelspec.outlier_files&#39;</span><span class="p">),</span>
      <span class="p">(</span><span class="s1">&#39;skullstrip.mask_file&#39;</span><span class="p">,</span>
       <span class="s1">&#39;level1design.mask_image&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;normalize.normalized_source&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;overlaystats.background_image&#39;</span><span class="p">)]),</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
<div class="section" id="data-specific-components">
<h2>Data specific components<a class="headerlink" href="#data-specific-components" title="Permalink to this headline">¶</a></h2>
<p>The nipype tutorial contains data for two subjects.  Subject data
is in two subdirectories, <code class="docutils literal notranslate"><span class="pre">s1</span></code> and <code class="docutils literal notranslate"><span class="pre">s2</span></code>.  Each subject directory
contains four functional volumes: f3.nii, f5.nii, f7.nii, f10.nii. And
one anatomical volume named struct.nii.</p>
<p>Below we set some variables to inform the <code class="docutils literal notranslate"><span class="pre">datasource</span></code> about the
layout of our data.  We specify the location of the data, the subject
sub-directories and a dictionary that maps each run to a mnemonic (or
field) for the run type (<code class="docutils literal notranslate"><span class="pre">struct</span></code> or <code class="docutils literal notranslate"><span class="pre">func</span></code>).  These fields become
the output fields of the <code class="docutils literal notranslate"><span class="pre">datasource</span></code> node in the pipeline.</p>
<p>In the example below, run ‘f3’ is of type ‘func’ and gets mapped to a
nifti filename through a template ‘%s.nii’. So ‘f3’ would become
‘f3.nii’.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Specify the subject directories</span>
<span class="n">subject_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;s1&#39;</span><span class="p">,</span> <span class="s1">&#39;s3&#39;</span><span class="p">]</span>
<span class="c1"># Map field names to individual subject runs.</span>
<span class="n">info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">func</span><span class="o">=</span><span class="p">[[</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;f3&#39;</span><span class="p">,</span> <span class="s1">&#39;f5&#39;</span><span class="p">,</span> <span class="s1">&#39;f7&#39;</span><span class="p">,</span> <span class="s1">&#39;f10&#39;</span><span class="p">]]],</span>
    <span class="n">struct</span><span class="o">=</span><span class="p">[[</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;struct&#39;</span><span class="p">]])</span>

<span class="n">infosource</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
    <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;subject_id&#39;</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;infosource&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Here we set up iteration over all the subjects. The following line
is a particular example of the flexibility of the system.  The
<code class="docutils literal notranslate"><span class="pre">datasource</span></code> attribute <code class="docutils literal notranslate"><span class="pre">iterables</span></code> tells the pipeline engine that
it should repeat the analysis on each of the items in the
<code class="docutils literal notranslate"><span class="pre">subject_list</span></code>. In the current example, the entire first level
preprocessing and estimation will be repeated for each subject
contained in subject_list.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">infosource</span><span class="o">.</span><span class="n">iterables</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="n">subject_list</span><span class="p">)</span>
</pre></div>
</div>
<p>Now we create a <code class="xref py py-class docutils literal notranslate"><span class="pre">nipype.interfaces.io.DataGrabber</span></code> object and
fill in the information from above about the layout of our data.  The
<code class="xref py py-class docutils literal notranslate"><span class="pre">nipype.pipeline.NodeWrapper</span></code> module wraps the interface object
and provides additional housekeeping and pipeline specific
functionality.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">datasource</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
    <span class="n">nio</span><span class="o">.</span><span class="n">DataGrabber</span><span class="p">(</span><span class="n">infields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;subject_id&#39;</span><span class="p">],</span> <span class="n">outfields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="s1">&#39;struct&#39;</span><span class="p">]),</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;datasource&#39;</span><span class="p">)</span>
<span class="n">datasource</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;nipype-tutorial/data/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.nii&#39;</span>
<span class="n">datasource</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">template_args</span> <span class="o">=</span> <span class="n">info</span>
<span class="n">datasource</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">sort_filelist</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
<div class="section" id="experimental-paradigm-specific-components">
<h2>Experimental paradigm specific components<a class="headerlink" href="#experimental-paradigm-specific-components" title="Permalink to this headline">¶</a></h2>
<p>Here we create a function that returns subject-specific information
about the experimental paradigm. This is used by the
<code class="xref py py-class docutils literal notranslate"><span class="pre">nipype.interfaces.spm.SpecifyModel</span></code> to create the information
necessary to generate an SPM design matrix. In this tutorial, the same
paradigm was used for every participant.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">subjectinfo</span><span class="p">(</span><span class="n">subject_id</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">nipype.interfaces.base</span> <span class="k">import</span> <span class="n">Bunch</span>
    <span class="kn">from</span> <span class="nn">copy</span> <span class="k">import</span> <span class="n">deepcopy</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Subject ID: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">subject_id</span><span class="p">))</span>
    <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Task-Odd&#39;</span><span class="p">,</span> <span class="s1">&#39;Task-Even&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">onsets</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="mi">60</span><span class="p">)),</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">45</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="mi">60</span><span class="p">))]</span>
        <span class="n">output</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">r</span><span class="p">,</span>
                      <span class="n">Bunch</span><span class="p">(</span>
                          <span class="n">conditions</span><span class="o">=</span><span class="n">names</span><span class="p">,</span>
                          <span class="n">onsets</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">onsets</span><span class="p">),</span>
                          <span class="n">durations</span><span class="o">=</span><span class="p">[[</span><span class="mi">15</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">names</span><span class="p">],</span>
                          <span class="n">amplitudes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">tmod</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">pmod</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">regressor_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">regressors</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">output</span>
</pre></div>
</div>
<p>Setup the contrast structure that needs to be evaluated. This is a
list of lists. The inner list specifies the contrasts and has the
following format - [Name,Stat,[list of condition names],[weights on
those conditions]. The condition names must match the <cite>names</cite> listed
in the <cite>subjectinfo</cite> function described above.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cont1</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Task&gt;Baseline&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;Task-Odd&#39;</span><span class="p">,</span> <span class="s1">&#39;Task-Even&#39;</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>
<span class="n">cont2</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Task-Odd&gt;Task-Even&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;Task-Odd&#39;</span><span class="p">,</span> <span class="s1">&#39;Task-Even&#39;</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">contrasts</span> <span class="o">=</span> <span class="p">[</span><span class="n">cont1</span><span class="p">,</span> <span class="n">cont2</span><span class="p">]</span>

<span class="c1"># set up node specific inputs</span>
<span class="n">modelspecref</span> <span class="o">=</span> <span class="n">l1pipeline</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">modelspec</span>
<span class="n">modelspecref</span><span class="o">.</span><span class="n">input_units</span> <span class="o">=</span> <span class="s1">&#39;secs&#39;</span>
<span class="n">modelspecref</span><span class="o">.</span><span class="n">output_units</span> <span class="o">=</span> <span class="s1">&#39;secs&#39;</span>
<span class="n">modelspecref</span><span class="o">.</span><span class="n">time_repetition</span> <span class="o">=</span> <span class="mf">3.</span>
<span class="n">modelspecref</span><span class="o">.</span><span class="n">high_pass_filter_cutoff</span> <span class="o">=</span> <span class="mi">120</span>

<span class="n">l1designref</span> <span class="o">=</span> <span class="n">l1pipeline</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">level1design</span>
<span class="n">l1designref</span><span class="o">.</span><span class="n">timing_units</span> <span class="o">=</span> <span class="n">modelspecref</span><span class="o">.</span><span class="n">output_units</span>
<span class="n">l1designref</span><span class="o">.</span><span class="n">interscan_interval</span> <span class="o">=</span> <span class="n">modelspecref</span><span class="o">.</span><span class="n">time_repetition</span>

<span class="n">l1pipeline</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">contrastestimate</span><span class="o">.</span><span class="n">contrasts</span> <span class="o">=</span> <span class="n">contrasts</span>

<span class="c1"># Iterate over each contrast and create report images.</span>
<span class="n">selectcontrast</span><span class="o">.</span><span class="n">iterables</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="p">[[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">contrasts</span><span class="p">))])</span>
</pre></div>
</div>
<p>The nodes created above do not describe the flow of data. They merely
describe the parameters used for each function. In this section we
setup the connections between the nodes such that appropriate outputs
from nodes are piped into appropriate inputs of other nodes.
Use the <code class="xref py py-class docutils literal notranslate"><span class="pre">nipype.pipeline.engine.Pipeline</span></code> to create a
graph-based execution pipeline for first level analysis. The config
options tells the pipeline engine to use <cite>workdir</cite> as the disk
location to use when running the processes and keeping their
outputs. The <cite>use_parameterized_dirs</cite> tells the engine to create
sub-directories under <cite>workdir</cite> corresponding to the iterables in the
pipeline. Thus for this pipeline there will be subject specific
The <code class="docutils literal notranslate"><span class="pre">nipype.pipeline.engine.Pipeline.connect</span></code> function creates the
links between the processes, i.e., how data should flow in and out of</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">level1</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;level1&quot;</span><span class="p">)</span>
<span class="n">level1</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;spm_tutorial2/workingdir&#39;</span><span class="p">)</span>

<span class="n">level1</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
    <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">datasource</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;in_data&#39;</span><span class="p">,</span> <span class="s1">&#39;base_directory&#39;</span><span class="p">)]),</span>
    <span class="p">(</span><span class="n">infosource</span><span class="p">,</span> <span class="n">datasource</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;subject_id&#39;</span><span class="p">)]),</span>
    <span class="p">(</span><span class="n">datasource</span><span class="p">,</span> <span class="n">l1pipeline</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="s1">&#39;preproc.realign.in_files&#39;</span><span class="p">),</span>
                              <span class="p">(</span><span class="s1">&#39;struct&#39;</span><span class="p">,</span> <span class="s1">&#39;preproc.coregister.target&#39;</span><span class="p">),</span>
                              <span class="p">(</span><span class="s1">&#39;struct&#39;</span><span class="p">,</span> <span class="s1">&#39;preproc.normalize.source&#39;</span><span class="p">)]),</span>
    <span class="p">(</span><span class="n">infosource</span><span class="p">,</span> <span class="n">l1pipeline</span><span class="p">,</span> <span class="p">[((</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="n">subjectinfo</span><span class="p">),</span>
                               <span class="s1">&#39;analysis.modelspec.subject_info&#39;</span><span class="p">)]),</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
<div class="section" id="setup-storage-results">
<h2>Setup storage results<a class="headerlink" href="#setup-storage-results" title="Permalink to this headline">¶</a></h2>
<p>Use <code class="xref py py-class docutils literal notranslate"><span class="pre">nipype.interfaces.io.DataSink</span></code> to store selected outputs
from the pipeline in a specific location. This allows the user to
selectively choose important output bits from the analysis and keep
them.</p>
<p>The first step is to create a datasink node and then to connect
outputs from the modules above to storage locations. These take the
following form directory_name[.[&#64;]subdir] where parts between [] are
optional. For example ‘realign.&#64;mean’ below creates a directory called
realign in ‘l1output/subject_id/’ and stores the mean image output
from the Realign process in the realign directory. If the &#64; is left
out, then a sub-directory with the name ‘mean’ would be created and
the mean image would be copied to that directory.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">datasink</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">nio</span><span class="o">.</span><span class="n">DataSink</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;datasink&quot;</span><span class="p">)</span>
 <span class="n">datasink</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">base_directory</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;spm_tutorial2/l1output&#39;</span><span class="p">)</span>
 <span class="n">report</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">nio</span><span class="o">.</span><span class="n">DataSink</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;report&#39;</span><span class="p">)</span>
 <span class="n">report</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">base_directory</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;spm_tutorial2/report&#39;</span><span class="p">)</span>
 <span class="n">report</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">parameterization</span> <span class="o">=</span> <span class="kc">False</span>


 <span class="k">def</span> <span class="nf">getstripdir</span><span class="p">(</span><span class="n">subject_id</span><span class="p">):</span>
     <span class="kn">import</span> <span class="nn">os.path</span> <span class="k">as</span> <span class="nn">op</span>
     <span class="k">return</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
         <span class="n">op</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;spm_tutorial2/workingdir&#39;</span><span class="p">),</span> <span class="s1">&#39;_subject_id_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">subject_id</span><span class="p">)</span>


 <span class="c1"># store relevant outputs from various stages of the 1st level analysis</span>
 <span class="n">level1</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
     <span class="p">(</span><span class="n">infosource</span><span class="p">,</span> <span class="n">datasink</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;container&#39;</span><span class="p">),</span>
                             <span class="p">((</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="n">getstripdir</span><span class="p">),</span> <span class="s1">&#39;strip_dir&#39;</span><span class="p">)]),</span>
     <span class="p">(</span><span class="n">l1pipeline</span><span class="p">,</span> <span class="n">datasink</span><span class="p">,</span>
      <span class="p">[(</span><span class="s1">&#39;analysis.contrastestimate.con_images&#39;</span><span class="p">,</span> <span class="s1">&#39;contrasts.@con&#39;</span><span class="p">),</span>
       <span class="p">(</span><span class="s1">&#39;analysis.contrastestimate.spmT_images&#39;</span><span class="p">,</span> <span class="s1">&#39;contrasts.@T&#39;</span><span class="p">)]),</span>
     <span class="p">(</span><span class="n">infosource</span><span class="p">,</span> <span class="n">report</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;container&#39;</span><span class="p">),</span>
                           <span class="p">((</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="n">getstripdir</span><span class="p">),</span> <span class="s1">&#39;strip_dir&#39;</span><span class="p">)]),</span>
     <span class="p">(</span><span class="n">l1pipeline</span><span class="p">,</span> <span class="n">report</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;analysis.slicestats.out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;@report&#39;</span><span class="p">)]),</span>
 <span class="p">])</span>

<span class="n">code</span> <span class="n">discussed</span> <span class="n">above</span> <span class="n">sets</span> <span class="n">up</span> <span class="nb">all</span> <span class="n">the</span> <span class="n">necessary</span> <span class="n">data</span> <span class="n">structures</span>
</pre></div>
</div>
<p>opriate parameters and the connectivity between the
sses, but does not generate any output. To actually run the
sis on the data the <code class="docutils literal notranslate"><span class="pre">nipype.pipeline.engine.Pipeline.Run</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">level1</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;MultiProc&#39;</span><span class="p">)</span>
    <span class="n">level1</span><span class="o">.</span><span class="n">write_graph</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="setup-level-2-pipeline">
<h2>Setup level 2 pipeline<a class="headerlink" href="#setup-level-2-pipeline" title="Permalink to this headline">¶</a></h2>
<p>Use <code class="xref py py-class docutils literal notranslate"><span class="pre">nipype.interfaces.io.DataGrabber</span></code> to extract the contrast
images across a group of first level subjects. Unlike the previous
pipeline that iterated over subjects, this pipeline will iterate over
contrasts.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># collect all the con images for each contrast.</span>
<span class="n">contrast_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">contrasts</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">l2source</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">nio</span><span class="o">.</span><span class="n">DataGrabber</span><span class="p">(</span><span class="n">infields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fwhm&#39;</span><span class="p">,</span> <span class="s1">&#39;con&#39;</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;l2source&quot;</span><span class="p">)</span>
<span class="c1"># we use .*i* to capture both .img (SPM8) and .nii (SPM12)</span>
<span class="n">l2source</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
    <span class="s1">&#39;spm_tutorial2/l1output/*/con*/*/_fwhm_</span><span class="si">%d</span><span class="s1">/con_</span><span class="si">%04d</span><span class="s1">.*i*&#39;</span><span class="p">)</span>
<span class="c1"># iterate over all contrast images</span>
<span class="n">l2source</span><span class="o">.</span><span class="n">iterables</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;fwhm&#39;</span><span class="p">,</span> <span class="n">fwhmlist</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;con&#39;</span><span class="p">,</span> <span class="n">contrast_ids</span><span class="p">)]</span>
<span class="n">l2source</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">sort_filelist</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
<p>Use <code class="xref py py-class docutils literal notranslate"><span class="pre">nipype.interfaces.spm.OneSampleTTestDesign</span></code> to perform a
simple statistical analysis of the contrasts from the group of
n this example).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># setup a 1-sample t-test node</span>
<span class="n">onesamplettestdes</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">spm</span><span class="o">.</span><span class="n">OneSampleTTestDesign</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;onesampttestdes&quot;</span><span class="p">)</span>
<span class="n">l2estimate</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">spm</span><span class="o">.</span><span class="n">EstimateModel</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;level2estimate&quot;</span><span class="p">)</span>
<span class="n">l2estimate</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">estimation_method</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Classical&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
<span class="n">l2conestimate</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">spm</span><span class="o">.</span><span class="n">EstimateContrast</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;level2conestimate&quot;</span><span class="p">)</span>
<span class="n">cont1</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Group&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">l2conestimate</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">contrasts</span> <span class="o">=</span> <span class="p">[</span><span class="n">cont1</span><span class="p">]</span>
<span class="n">l2conestimate</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">group_contrast</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
<p>As before, we setup a pipeline to connect these two nodes (l2source
lettest).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">l2pipeline</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;level2&quot;</span><span class="p">)</span>
<span class="n">l2pipeline</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;spm_tutorial2/l2output&#39;</span><span class="p">)</span>
<span class="n">l2pipeline</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
    <span class="p">(</span><span class="n">l2source</span><span class="p">,</span> <span class="n">onesamplettestdes</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;outfiles&#39;</span><span class="p">,</span> <span class="s1">&#39;in_files&#39;</span><span class="p">)]),</span>
    <span class="p">(</span><span class="n">onesamplettestdes</span><span class="p">,</span> <span class="n">l2estimate</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;spm_mat_file&#39;</span><span class="p">,</span> <span class="s1">&#39;spm_mat_file&#39;</span><span class="p">)]),</span>
    <span class="p">(</span><span class="n">l2estimate</span><span class="p">,</span> <span class="n">l2conestimate</span><span class="p">,</span>
     <span class="p">[(</span><span class="s1">&#39;spm_mat_file&#39;</span><span class="p">,</span> <span class="s1">&#39;spm_mat_file&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;beta_images&#39;</span><span class="p">,</span> <span class="s1">&#39;beta_images&#39;</span><span class="p">),</span>
      <span class="p">(</span><span class="s1">&#39;residual_image&#39;</span><span class="p">,</span> <span class="s1">&#39;residual_image&#39;</span><span class="p">)]),</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
<div class="section" id="execute-the-second-level-pipeline">
<h2>Execute the second level pipeline<a class="headerlink" href="#execute-the-second-level-pipeline" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">l2pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;MultiProc&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition-example-source-code admonition">
<p class="first admonition-title">Example source code</p>
<p class="last">You can download <a class="reference download internal" download="" href="../../_downloads/1ef5a5be20c03b45392c58259edecd34/fmri_spm_nested.py"><code class="xref download docutils literal notranslate"><span class="pre">the</span> <span class="pre">full</span> <span class="pre">source</span> <span class="pre">code</span> <span class="pre">of</span> <span class="pre">this</span> <span class="pre">example</span></code></a>.
This same script is also included in the Nipype source distribution under the
<code class="file docutils literal notranslate"><span class="pre">examples</span></code> directory.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2009-18, Neuroimaging in Python team.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.1.
    </div>
<div class="footer">This page uses <a href="http://analytics.google.com/">
Google Analytics</a> to collect statistics. You can disable it by blocking
the JavaScript coming from www.google-analytics.com.
</div>

  </body>
</html>