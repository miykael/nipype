
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Neuroimaging in Python - Pipelines and Interfaces &#8212; nipy pipeline and interfaces package</title>
    <link rel="stylesheet" href="../../_static/nipype.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
 
<meta name="keywords" content="nipype, neuroimaging, pipeline, workflow, parallel, python, neuroscience">
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-339450-7', 'nipy.org/nipype');
  ga('send', 'pageview');
</script>
<script>
  ((window.gitter = {}).chat = {}).options = {
    room: 'nipy/nipype'
  };
</script>
<script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>

  </head><body>
<div class="header-wrapper">
    <div style="background-color: white; text-align: left; padding: 10px 10px 15px 15px">
            <a href="../../index.html">
            <img src="../../_static/nipype-banner-bg.png" alt="NIPY logo"  border="0" />
        <div style="margin-top: 1em;
                border-top: 1px solid #AAA;
                border-bottom: 1px solid #AAA;
                border-radius: 5px;
                padding: 3px 1em;">
            <link rel="stylesheet" href="http://www.google.com/cse/style/look/default.css" type="text/css" />
<style type="text/css">
    a.navbar {
    color: ;
    letter-spacing: .05em;
    font-weight: bold;
        }
</style>

<a class="navbar" href="../../index.html">Home</a> ·
<a class="navbar" href="../../quickstart.html">Quickstart</a> ·
<a class="navbar" href="../../documentation.html">Documentation</a> ·
<a class="navbar" href="../../about.html">About</a> ·
<a class="navbar" href="http://nipy.org">Nipy</a>

        </div>
    </div>
</div>

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<style type="text/css">
    input.gsc-input {
        border-color: #BCCDF0;
    }
    input.gsc-search-button {
        border-color: #666666;
        background-color: #CECECE;
        padding: 0;
    }
    div.sphinxsidebar .tile {
        border: 1px solid #D1DDE2;
        border-radius: 10px;
        background-color: #E1E8EC;
        padding-left: 0.5em;
        margin: 1em 0;
    }
    div.sphinxsidebar input[type="text"] {
        width: 100%;
    }
    div.sphinxsidebar input[type="submit"] {
        width: 100%;
    }
</style>

<div class="sidebarblock">
    <script>
      (function() {
        var cx = '010960497803984932957:u8pmqf7fdoq';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:search></gcse:search>
</div>

  <h3><a href="../../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">fMRI: FSL</a><ul>
<li><a class="reference internal" href="#preliminaries">Preliminaries</a></li>
<li><a class="reference internal" href="#setting-up-workflows">Setting up workflows</a></li>
<li><a class="reference internal" href="#setup-preprocessing-workflow">Setup preprocessing workflow</a></li>
<li><a class="reference internal" href="#set-up-model-fitting-workflow">Set up model fitting workflow</a></li>
<li><a class="reference internal" href="#set-up-fixed-effects-workflow">Set up fixed-effects workflow</a></li>
<li><a class="reference internal" href="#set-up-first-level-workflow">Set up first-level workflow</a></li>
<li><a class="reference internal" href="#experiment-specific-components">Experiment specific components</a><ul>
<li><a class="reference internal" href="#set-up-complete-workflow">Set up complete workflow</a></li>
</ul>
</li>
<li><a class="reference internal" href="#execute-the-pipeline">Execute the pipeline</a></li>
</ul>
</li>
</ul>

<style type="text/css">
    div.sphinxsidebar .tile {
        border: 1px solid #D1DDE2;
        border-radius: 10px;
        background-color: #E1E8EC;
        padding-left: 0.5em;
        margin: 1em 0;
    }
</style>
<div class="sidebarblock">
    <h3>Versions</h3>

    <div class="tile">
        <table style="width: 100%;">
            <tr style="font-weight: bold;">
                <td align="left">Release</td><td align="right">Devel</td>
            </tr>
            <tr>
                <td align="left">1.1.3</td><td align="right">1.1.4-dev+g93c475b</td>
            </tr>
            <tr>
                <td align="left"><a href="../install.html">Download</a></td>
                <td align="right"><a href="https://github.com/nipy/nipype">Github</a></td>
            </tr>
        </table>
    </div>
</div>


<script type="text/javascript">
    (function() {
        var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
        po.src = 'https://apis.google.com/js/plusone.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
    })();
</script>

<h3>Links</h3>

<ul>
    <li>Docs: <a href="http://nipy.org/nipype">Stable</a> · <a href="http://nipype.readthedocs.org/en/latest/">Dev</a></li>
    <li>Code: <a href="http://github.com/nipy/nipype">Github</a> · <a href="http://github.com/nipy/nipype/issues">Bugs-Requests</a></li>
    <li>Forum: <a href="https://neurostars.org/search?q=nipype">User</a> · <a href="https://mail.python.org/mailman/listinfo/neuroimaging">Developer</a></li>
    <li>Chat: <a href="https://gitter.im/nipy/nipype">Gitter</a> · <a href="https://brainhack.slack.com/messages/C1FR76RAL">Slack</a></li>
    <li><a href="about.html#funding">Funding</a> · <a href="http://nipy.org/software/license/index.html"><img src="https://img.shields.io/pypi/l/nipype.svg" alt="License"></a></li>
    <li><a href="https://travis-ci.org/nipy/nipype"><img src="https://travis-ci.org/nipy/nipype.png?branch=master" alt="travis"></a> · <a href='https://codecov.io/gh/nipy/nipype'><img src='https://codecov.io/gh/nipy/nipype/branch/master/graph/badge.svg' alt='Coverage Status' /></a></li>
    <a href='https://pypi.python.org/pypi/nipype/'><img src='https://img.shields.io/pypi/pyversions/nipype.svg' alt='Python Versions' /></a></li>
</ul>

 
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="fmri-fsl">
<span id="example-fmri-fsl"></span><h1>fMRI: FSL<a class="headerlink" href="#fmri-fsl" title="Permalink to this headline">¶</a></h1>
<p>A workflow that uses fsl to perform a first level analysis on the nipype
tutorial data set:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">fmri_fsl</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>First tell python where to find the appropriate functions.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="k">import</span> <span class="nb">str</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="k">import</span> <span class="nb">range</span>

<span class="kn">import</span> <span class="nn">os</span>  <span class="c1"># system functions</span>

<span class="kn">import</span> <span class="nn">nipype.interfaces.io</span> <span class="k">as</span> <span class="nn">nio</span>  <span class="c1"># Data i/o</span>
<span class="kn">import</span> <span class="nn">nipype.interfaces.fsl</span> <span class="k">as</span> <span class="nn">fsl</span>  <span class="c1"># fsl</span>
<span class="kn">import</span> <span class="nn">nipype.interfaces.utility</span> <span class="k">as</span> <span class="nn">util</span>  <span class="c1"># utility</span>
<span class="kn">import</span> <span class="nn">nipype.pipeline.engine</span> <span class="k">as</span> <span class="nn">pe</span>  <span class="c1"># pypeline engine</span>
<span class="kn">import</span> <span class="nn">nipype.algorithms.modelgen</span> <span class="k">as</span> <span class="nn">model</span>  <span class="c1"># model generation</span>
<span class="kn">import</span> <span class="nn">nipype.algorithms.rapidart</span> <span class="k">as</span> <span class="nn">ra</span>  <span class="c1"># artifact detection</span>
</pre></div>
</div>
<div class="section" id="preliminaries">
<h2>Preliminaries<a class="headerlink" href="#preliminaries" title="Permalink to this headline">¶</a></h2>
<p>Setup any package specific configuration. The output file format for FSL
routines is being set to compressed NIFTI.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fsl</span><span class="o">.</span><span class="n">FSLCommand</span><span class="o">.</span><span class="n">set_default_output_type</span><span class="p">(</span><span class="s1">&#39;NIFTI_GZ&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="setting-up-workflows">
<h2>Setting up workflows<a class="headerlink" href="#setting-up-workflows" title="Permalink to this headline">¶</a></h2>
<p>In this tutorial we will be setting up a hierarchical workflow for fsl
analysis. This will demonstrate how pre-defined workflows can be setup and
shared across users, projects and labs.</p>
</div>
<div class="section" id="setup-preprocessing-workflow">
<h2>Setup preprocessing workflow<a class="headerlink" href="#setup-preprocessing-workflow" title="Permalink to this headline">¶</a></h2>
<p>This is a generic fsl feat preprocessing workflow encompassing skull stripping,
motion correction and smoothing operations.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">preproc</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;preproc&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Set up a node to define all inputs required for the preprocessing workflow</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">inputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">util</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span>
        <span class="s1">&#39;func&#39;</span><span class="p">,</span>
        <span class="s1">&#39;struct&#39;</span><span class="p">,</span>
    <span class="p">]),</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;inputspec&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Convert functional images to float representation. Since there can be more than
one functional run we use a MapNode to convert each run.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">img2float</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageMaths</span><span class="p">(</span>
        <span class="n">out_data_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="n">op_string</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;_dtype&#39;</span><span class="p">),</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;img2float&#39;</span><span class="p">)</span>
<span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="n">img2float</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Extract the middle volume of the first run as the reference</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">extract_ref</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ExtractROI</span><span class="p">(</span><span class="n">t_size</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;extractref&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Define a function to pick the first file from a list of files</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">pickfirst</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">files</span>


<span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">img2float</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">pickfirst</span><span class="p">),</span> <span class="n">extract_ref</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Define a function to return the 1 based index of the middle volume</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">getmiddlevolume</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">nibabel</span> <span class="k">import</span> <span class="n">load</span>
    <span class="kn">from</span> <span class="nn">nipype.utils</span> <span class="k">import</span> <span class="n">NUMPY_MMAP</span>
    <span class="n">funcfile</span> <span class="o">=</span> <span class="n">func</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">funcfile</span> <span class="o">=</span> <span class="n">func</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">timepoints</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="n">funcfile</span><span class="p">,</span> <span class="n">mmap</span><span class="o">=</span><span class="n">NUMPY_MMAP</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">timepoints</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>


<span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="n">getmiddlevolume</span><span class="p">),</span> <span class="n">extract_ref</span><span class="p">,</span> <span class="s1">&#39;t_min&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Realign the functional runs to the middle volume of the first run</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">motion_correct</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">MCFLIRT</span><span class="p">(</span><span class="n">save_mats</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save_plots</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;realign&#39;</span><span class="p">,</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">])</span>
<span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">img2float</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">motion_correct</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
<span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">extract_ref</span><span class="p">,</span> <span class="s1">&#39;roi_file&#39;</span><span class="p">,</span> <span class="n">motion_correct</span><span class="p">,</span> <span class="s1">&#39;ref_file&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Plot the estimated motion parameters</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plot_motion</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">PlotMotionParams</span><span class="p">(</span><span class="n">in_source</span><span class="o">=</span><span class="s1">&#39;fsl&#39;</span><span class="p">),</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;plot_motion&#39;</span><span class="p">,</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">])</span>
<span class="n">plot_motion</span><span class="o">.</span><span class="n">iterables</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;plot_type&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;rotations&#39;</span><span class="p">,</span> <span class="s1">&#39;translations&#39;</span><span class="p">])</span>
<span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">motion_correct</span><span class="p">,</span> <span class="s1">&#39;par_file&#39;</span><span class="p">,</span> <span class="n">plot_motion</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Extract the mean volume of the first functional run</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">meanfunc</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageMaths</span><span class="p">(</span><span class="n">op_string</span><span class="o">=</span><span class="s1">&#39;-Tmean&#39;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;_mean&#39;</span><span class="p">),</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;meanfunc&#39;</span><span class="p">)</span>
<span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">motion_correct</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">pickfirst</span><span class="p">),</span> <span class="n">meanfunc</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Strip the skull from the mean functional to generate a mask</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">meanfuncmask</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">BET</span><span class="p">(</span><span class="n">mask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">no_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="mf">0.3</span><span class="p">),</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;meanfuncmask&#39;</span><span class="p">)</span>
<span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">meanfunc</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">meanfuncmask</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Mask the functional runs with the extracted mask</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">maskfunc</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageMaths</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;_bet&#39;</span><span class="p">,</span> <span class="n">op_string</span><span class="o">=</span><span class="s1">&#39;-mas&#39;</span><span class="p">),</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;maskfunc&#39;</span><span class="p">)</span>
<span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">motion_correct</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">maskfunc</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
<span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">meanfuncmask</span><span class="p">,</span> <span class="s1">&#39;mask_file&#39;</span><span class="p">,</span> <span class="n">maskfunc</span><span class="p">,</span> <span class="s1">&#39;in_file2&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Determine the 2nd and 98th percentile intensities of each functional run</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">getthresh</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageStats</span><span class="p">(</span><span class="n">op_string</span><span class="o">=</span><span class="s1">&#39;-p 2 -p 98&#39;</span><span class="p">),</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;getthreshold&#39;</span><span class="p">)</span>
<span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">maskfunc</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">getthresh</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Threshold the first run of the functional data at 10% of the 98th percentile</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">threshold</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageMaths</span><span class="p">(</span><span class="n">out_data_type</span><span class="o">=</span><span class="s1">&#39;char&#39;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;_thresh&#39;</span><span class="p">),</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;threshold&#39;</span><span class="p">)</span>
<span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">maskfunc</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">pickfirst</span><span class="p">),</span> <span class="n">threshold</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Define a function to get 10% of the intensity</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">getthreshop</span><span class="p">(</span><span class="n">thresh</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39;-thr </span><span class="si">%.10f</span><span class="s1"> -Tmin -bin&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">thresh</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>


<span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">getthresh</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;out_stat&#39;</span><span class="p">,</span> <span class="n">getthreshop</span><span class="p">),</span> <span class="n">threshold</span><span class="p">,</span> <span class="s1">&#39;op_string&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Determine the median value of the functional runs using the mask</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">medianval</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageStats</span><span class="p">(</span><span class="n">op_string</span><span class="o">=</span><span class="s1">&#39;-k </span><span class="si">%s</span><span class="s1"> -p 50&#39;</span><span class="p">),</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;medianval&#39;</span><span class="p">)</span>
<span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">motion_correct</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">medianval</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
<span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">medianval</span><span class="p">,</span> <span class="s1">&#39;mask_file&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Dilate the mask</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dilatemask</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageMaths</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;_dil&#39;</span><span class="p">,</span> <span class="n">op_string</span><span class="o">=</span><span class="s1">&#39;-dilF&#39;</span><span class="p">),</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dilatemask&#39;</span><span class="p">)</span>
<span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">dilatemask</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Mask the motion corrected functional runs with the dilated mask</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">maskfunc2</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageMaths</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;_mask&#39;</span><span class="p">,</span> <span class="n">op_string</span><span class="o">=</span><span class="s1">&#39;-mas&#39;</span><span class="p">),</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;maskfunc2&#39;</span><span class="p">)</span>
<span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">motion_correct</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">maskfunc2</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
<span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dilatemask</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">maskfunc2</span><span class="p">,</span> <span class="s1">&#39;in_file2&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Determine the mean image from each functional run</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">meanfunc2</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageMaths</span><span class="p">(</span><span class="n">op_string</span><span class="o">=</span><span class="s1">&#39;-Tmean&#39;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;_mean&#39;</span><span class="p">),</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;meanfunc2&#39;</span><span class="p">)</span>
<span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">maskfunc2</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">meanfunc2</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Merge the median values with the mean functional images into a coupled list</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mergenode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">util</span><span class="o">.</span><span class="n">Merge</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;hstack&#39;</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;merge&#39;</span><span class="p">)</span>
<span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">meanfunc2</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">mergenode</span><span class="p">,</span> <span class="s1">&#39;in1&#39;</span><span class="p">)</span>
<span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">medianval</span><span class="p">,</span> <span class="s1">&#39;out_stat&#39;</span><span class="p">,</span> <span class="n">mergenode</span><span class="p">,</span> <span class="s1">&#39;in2&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Smooth each run using SUSAN with the brightness threshold set to 75% of the
median value for each run and a mask constituting the mean functional</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">smooth</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">SUSAN</span><span class="p">(),</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">,</span> <span class="s1">&#39;brightness_threshold&#39;</span><span class="p">,</span> <span class="s1">&#39;usans&#39;</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;smooth&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Define a function to get the brightness threshold for SUSAN</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">getbtthresh</span><span class="p">(</span><span class="n">medianvals</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="mf">0.75</span> <span class="o">*</span> <span class="n">val</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">medianvals</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">getusans</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[[</span><span class="nb">tuple</span><span class="p">([</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">0.75</span> <span class="o">*</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]])]</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>


<span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">maskfunc2</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">smooth</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
<span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">medianval</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;out_stat&#39;</span><span class="p">,</span> <span class="n">getbtthresh</span><span class="p">),</span> <span class="n">smooth</span><span class="p">,</span>
                <span class="s1">&#39;brightness_threshold&#39;</span><span class="p">)</span>
<span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">mergenode</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="n">getusans</span><span class="p">),</span> <span class="n">smooth</span><span class="p">,</span> <span class="s1">&#39;usans&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Mask the smoothed data with the dilated mask</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">maskfunc3</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageMaths</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;_mask&#39;</span><span class="p">,</span> <span class="n">op_string</span><span class="o">=</span><span class="s1">&#39;-mas&#39;</span><span class="p">),</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;maskfunc3&#39;</span><span class="p">)</span>
<span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">smooth</span><span class="p">,</span> <span class="s1">&#39;smoothed_file&#39;</span><span class="p">,</span> <span class="n">maskfunc3</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
<span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dilatemask</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">maskfunc3</span><span class="p">,</span> <span class="s1">&#39;in_file2&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Scale each volume of the run so that the median value of the run is set to 10000</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">intnorm</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageMaths</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;_intnorm&#39;</span><span class="p">),</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">,</span> <span class="s1">&#39;op_string&#39;</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;intnorm&#39;</span><span class="p">)</span>
<span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">maskfunc3</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">intnorm</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Define a function to get the scaling factor for intensity normalization</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">getinormscale</span><span class="p">(</span><span class="n">medianvals</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;-mul </span><span class="si">%.10f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mf">10000.</span> <span class="o">/</span> <span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">medianvals</span><span class="p">]</span>


<span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">medianval</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;out_stat&#39;</span><span class="p">,</span> <span class="n">getinormscale</span><span class="p">),</span> <span class="n">intnorm</span><span class="p">,</span> <span class="s1">&#39;op_string&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Perform temporal highpass filtering on the data</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">highpass</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageMaths</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;_tempfilt&#39;</span><span class="p">),</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;highpass&#39;</span><span class="p">)</span>
<span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">intnorm</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">highpass</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Generate a mean functional image from the first run</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">meanfunc3</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageMaths</span><span class="p">(</span><span class="n">op_string</span><span class="o">=</span><span class="s1">&#39;-Tmean&#39;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;_mean&#39;</span><span class="p">),</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;meanfunc3&#39;</span><span class="p">)</span>
<span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">highpass</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">pickfirst</span><span class="p">),</span> <span class="n">meanfunc3</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Strip the structural image and coregister the mean functional image to the
structural image</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nosestrip</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">BET</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mf">0.3</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;nosestrip&#39;</span><span class="p">)</span>
<span class="n">skullstrip</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">BET</span><span class="p">(</span><span class="n">mask</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;stripstruct&#39;</span><span class="p">)</span>

<span class="n">coregister</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">FLIRT</span><span class="p">(</span><span class="n">dof</span><span class="o">=</span><span class="mi">6</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;coregister&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Use <code class="xref py py-class docutils literal notranslate"><span class="pre">nipype.algorithms.rapidart</span></code> to determine which of the
images in the functional series are outliers based on deviations in
intensity and/or movement.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">art</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">ra</span><span class="o">.</span><span class="n">ArtifactDetect</span><span class="p">(</span>
        <span class="n">use_differences</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="n">use_norm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">norm_threshold</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">zintensity_threshold</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">parameter_source</span><span class="o">=</span><span class="s1">&#39;FSL&#39;</span><span class="p">,</span>
        <span class="n">mask_type</span><span class="o">=</span><span class="s1">&#39;file&#39;</span><span class="p">),</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;realigned_files&#39;</span><span class="p">,</span> <span class="s1">&#39;realignment_parameters&#39;</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;art&quot;</span><span class="p">)</span>

<span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
    <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">nosestrip</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;struct&#39;</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)]),</span>
    <span class="p">(</span><span class="n">nosestrip</span><span class="p">,</span> <span class="n">skullstrip</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)]),</span>
    <span class="p">(</span><span class="n">skullstrip</span><span class="p">,</span> <span class="n">coregister</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)]),</span>
    <span class="p">(</span><span class="n">meanfunc2</span><span class="p">,</span> <span class="n">coregister</span><span class="p">,</span> <span class="p">[((</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">pickfirst</span><span class="p">),</span> <span class="s1">&#39;reference&#39;</span><span class="p">)]),</span>
    <span class="p">(</span><span class="n">motion_correct</span><span class="p">,</span> <span class="n">art</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;par_file&#39;</span><span class="p">,</span> <span class="s1">&#39;realignment_parameters&#39;</span><span class="p">)]),</span>
    <span class="p">(</span><span class="n">maskfunc2</span><span class="p">,</span> <span class="n">art</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;realigned_files&#39;</span><span class="p">)]),</span>
    <span class="p">(</span><span class="n">dilatemask</span><span class="p">,</span> <span class="n">art</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;mask_file&#39;</span><span class="p">)]),</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
<div class="section" id="set-up-model-fitting-workflow">
<h2>Set up model fitting workflow<a class="headerlink" href="#set-up-model-fitting-workflow" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">modelfit</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;modelfit&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Use <code class="xref py py-class docutils literal notranslate"><span class="pre">nipype.algorithms.modelgen.SpecifyModel</span></code> to generate design information.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">modelspec</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">SpecifyModel</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;modelspec&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Use <code class="xref py py-class docutils literal notranslate"><span class="pre">nipype.interfaces.fsl.Level1Design</span></code> to generate a run specific fsf
file for analysis</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">level1design</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">Level1Design</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;level1design&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Use <code class="xref py py-class docutils literal notranslate"><span class="pre">nipype.interfaces.fsl.FEATModel</span></code> to generate a run specific mat
file for use by FILMGLS</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">modelgen</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">FEATModel</span><span class="p">(),</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;modelgen&#39;</span><span class="p">,</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fsf_file&#39;</span><span class="p">,</span> <span class="s1">&#39;ev_files&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>Use <code class="xref py py-class docutils literal notranslate"><span class="pre">nipype.interfaces.fsl.FILMGLS</span></code> to estimate a model specified by a
mat file and a functional run</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">modelestimate</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">FILMGLS</span><span class="p">(</span><span class="n">smooth_autocorr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mask_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">1000</span><span class="p">),</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;modelestimate&#39;</span><span class="p">,</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;design_file&#39;</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>Use <code class="xref py py-class docutils literal notranslate"><span class="pre">nipype.interfaces.fsl.ContrastMgr</span></code> to generate contrast estimates</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">conestimate</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ContrastMgr</span><span class="p">(),</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;conestimate&#39;</span><span class="p">,</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span>
        <span class="s1">&#39;tcon_file&#39;</span><span class="p">,</span> <span class="s1">&#39;param_estimates&#39;</span><span class="p">,</span> <span class="s1">&#39;sigmasquareds&#39;</span><span class="p">,</span> <span class="s1">&#39;corrections&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dof_file&#39;</span>
    <span class="p">])</span>

<span class="n">modelfit</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
    <span class="p">(</span><span class="n">modelspec</span><span class="p">,</span> <span class="n">level1design</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;session_info&#39;</span><span class="p">,</span> <span class="s1">&#39;session_info&#39;</span><span class="p">)]),</span>
    <span class="p">(</span><span class="n">level1design</span><span class="p">,</span> <span class="n">modelgen</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;fsf_files&#39;</span><span class="p">,</span> <span class="s1">&#39;fsf_file&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;ev_files&#39;</span><span class="p">,</span>
                                                          <span class="s1">&#39;ev_files&#39;</span><span class="p">)]),</span>
    <span class="p">(</span><span class="n">modelgen</span><span class="p">,</span> <span class="n">modelestimate</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;design_file&#39;</span><span class="p">,</span> <span class="s1">&#39;design_file&#39;</span><span class="p">)]),</span>
    <span class="p">(</span><span class="n">modelgen</span><span class="p">,</span> <span class="n">conestimate</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;con_file&#39;</span><span class="p">,</span> <span class="s1">&#39;tcon_file&#39;</span><span class="p">)]),</span>
    <span class="p">(</span><span class="n">modelestimate</span><span class="p">,</span> <span class="n">conestimate</span><span class="p">,</span>
     <span class="p">[(</span><span class="s1">&#39;param_estimates&#39;</span><span class="p">,</span> <span class="s1">&#39;param_estimates&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;sigmasquareds&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;sigmasquareds&#39;</span><span class="p">),</span>
      <span class="p">(</span><span class="s1">&#39;corrections&#39;</span><span class="p">,</span> <span class="s1">&#39;corrections&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;dof_file&#39;</span><span class="p">,</span> <span class="s1">&#39;dof_file&#39;</span><span class="p">)]),</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
<div class="section" id="set-up-fixed-effects-workflow">
<h2>Set up fixed-effects workflow<a class="headerlink" href="#set-up-fixed-effects-workflow" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fixed_fx</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;fixedfx&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Use <code class="xref py py-class docutils literal notranslate"><span class="pre">nipype.interfaces.fsl.Merge</span></code> to merge the copes and
varcopes for each condition</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">copemerge</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">Merge</span><span class="p">(</span><span class="n">dimension</span><span class="o">=</span><span class="s1">&#39;t&#39;</span><span class="p">),</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_files&#39;</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;copemerge&quot;</span><span class="p">)</span>

<span class="n">varcopemerge</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">Merge</span><span class="p">(</span><span class="n">dimension</span><span class="o">=</span><span class="s1">&#39;t&#39;</span><span class="p">),</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_files&#39;</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;varcopemerge&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Use <code class="xref py py-class docutils literal notranslate"><span class="pre">nipype.interfaces.fsl.L2Model</span></code> to generate subject and condition
specific level 2 model design files</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">level2model</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">L2Model</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;l2model&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Use <code class="xref py py-class docutils literal notranslate"><span class="pre">nipype.interfaces.fsl.FLAMEO</span></code> to estimate a second level model</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">flameo</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">FLAMEO</span><span class="p">(</span><span class="n">run_mode</span><span class="o">=</span><span class="s1">&#39;fe&#39;</span><span class="p">),</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;flameo&quot;</span><span class="p">,</span>
    <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cope_file&#39;</span><span class="p">,</span> <span class="s1">&#39;var_cope_file&#39;</span><span class="p">])</span>

<span class="n">fixed_fx</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
    <span class="p">(</span><span class="n">copemerge</span><span class="p">,</span> <span class="n">flameo</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;merged_file&#39;</span><span class="p">,</span> <span class="s1">&#39;cope_file&#39;</span><span class="p">)]),</span>
    <span class="p">(</span><span class="n">varcopemerge</span><span class="p">,</span> <span class="n">flameo</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;merged_file&#39;</span><span class="p">,</span> <span class="s1">&#39;var_cope_file&#39;</span><span class="p">)]),</span>
    <span class="p">(</span><span class="n">level2model</span><span class="p">,</span> <span class="n">flameo</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;design_mat&#39;</span><span class="p">,</span> <span class="s1">&#39;design_file&#39;</span><span class="p">),</span>
                           <span class="p">(</span><span class="s1">&#39;design_con&#39;</span><span class="p">,</span> <span class="s1">&#39;t_con_file&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;design_grp&#39;</span><span class="p">,</span>
                                                          <span class="s1">&#39;cov_split_file&#39;</span><span class="p">)]),</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
<div class="section" id="set-up-first-level-workflow">
<h2>Set up first-level workflow<a class="headerlink" href="#set-up-first-level-workflow" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sort_copes</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
    <span class="n">numelements</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">outfiles</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numelements</span><span class="p">):</span>
        <span class="n">outfiles</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">elements</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
            <span class="n">outfiles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elements</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">outfiles</span>


<span class="k">def</span> <span class="nf">num_copes</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>


<span class="n">firstlevel</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;firstlevel&#39;</span><span class="p">)</span>
<span class="n">firstlevel</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
    <span class="p">[(</span><span class="n">preproc</span><span class="p">,</span> <span class="n">modelfit</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;highpass.out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;modelspec.functional_runs&#39;</span><span class="p">),</span>
                          <span class="p">(</span><span class="s1">&#39;art.outlier_files&#39;</span><span class="p">,</span> <span class="s1">&#39;modelspec.outlier_files&#39;</span><span class="p">),</span>
                          <span class="p">(</span><span class="s1">&#39;highpass.out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;modelestimate.in_file&#39;</span><span class="p">)]),</span>
     <span class="p">(</span><span class="n">preproc</span><span class="p">,</span> <span class="n">fixed_fx</span><span class="p">,</span>
      <span class="p">[(</span><span class="s1">&#39;coregister.out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;flameo.mask_file&#39;</span><span class="p">)]),</span> <span class="p">(</span><span class="n">modelfit</span><span class="p">,</span> <span class="n">fixed_fx</span><span class="p">,</span> <span class="p">[</span>
          <span class="p">((</span><span class="s1">&#39;conestimate.copes&#39;</span><span class="p">,</span> <span class="n">sort_copes</span><span class="p">),</span> <span class="s1">&#39;copemerge.in_files&#39;</span><span class="p">),</span>
          <span class="p">((</span><span class="s1">&#39;conestimate.varcopes&#39;</span><span class="p">,</span> <span class="n">sort_copes</span><span class="p">),</span> <span class="s1">&#39;varcopemerge.in_files&#39;</span><span class="p">),</span>
          <span class="p">((</span><span class="s1">&#39;conestimate.copes&#39;</span><span class="p">,</span> <span class="n">num_copes</span><span class="p">),</span> <span class="s1">&#39;l2model.num_copes&#39;</span><span class="p">),</span>
      <span class="p">])])</span>
</pre></div>
</div>
</div>
<div class="section" id="experiment-specific-components">
<h2>Experiment specific components<a class="headerlink" href="#experiment-specific-components" title="Permalink to this headline">¶</a></h2>
<p>The nipype tutorial contains data for two subjects.  Subject data
is in two subdirectories, <code class="docutils literal notranslate"><span class="pre">s1</span></code> and <code class="docutils literal notranslate"><span class="pre">s2</span></code>.  Each subject directory
contains four functional volumes: f3.nii, f5.nii, f7.nii, f10.nii. And
one anatomical volume named struct.nii.</p>
<p>Below we set some variables to inform the <code class="docutils literal notranslate"><span class="pre">datasource</span></code> about the
layout of our data.  We specify the location of the data, the subject
sub-directories and a dictionary that maps each run to a mnemonic (or
field) for the run type (<code class="docutils literal notranslate"><span class="pre">struct</span></code> or <code class="docutils literal notranslate"><span class="pre">func</span></code>).  These fields become
the output fields of the <code class="docutils literal notranslate"><span class="pre">datasource</span></code> node in the pipeline.</p>
<p>In the example below, run ‘f3’ is of type ‘func’ and gets mapped to a
nifti filename through a template ‘%s.nii’. So ‘f3’ would become
‘f3.nii’.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Specify the location of the data.</span>
<span class="n">data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>
<span class="c1"># Specify the subject directories</span>
<span class="n">subject_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;s1&#39;</span><span class="p">]</span>  <span class="c1"># , &#39;s3&#39;]</span>
<span class="c1"># Map field names to individual subject runs.</span>
<span class="n">info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">func</span><span class="o">=</span><span class="p">[[</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;f3&#39;</span><span class="p">,</span> <span class="s1">&#39;f5&#39;</span><span class="p">,</span> <span class="s1">&#39;f7&#39;</span><span class="p">,</span> <span class="s1">&#39;f10&#39;</span><span class="p">]]],</span>
    <span class="n">struct</span><span class="o">=</span><span class="p">[[</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;struct&#39;</span><span class="p">]])</span>

<span class="n">infosource</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">util</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;subject_id&#39;</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;infosource&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Here we set up iteration over all the subjects. The following line
is a particular example of the flexibility of the system.  The
<code class="docutils literal notranslate"><span class="pre">datasource</span></code> attribute <code class="docutils literal notranslate"><span class="pre">iterables</span></code> tells the pipeline engine that
it should repeat the analysis on each of the items in the
<code class="docutils literal notranslate"><span class="pre">subject_list</span></code>. In the current example, the entire first level
preprocessing and estimation will be repeated for each subject
contained in subject_list.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">infosource</span><span class="o">.</span><span class="n">iterables</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="n">subject_list</span><span class="p">)</span>
</pre></div>
</div>
<p>Now we create a <code class="xref py py-class docutils literal notranslate"><span class="pre">nipype.interfaces.io.DataSource</span></code> object and
fill in the information from above about the layout of our data.  The
<code class="xref py py-class docutils literal notranslate"><span class="pre">nipype.pipeline.NodeWrapper</span></code> module wraps the interface object
and provides additional housekeeping and pipeline specific
functionality.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">datasource</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">=</span><span class="n">nio</span><span class="o">.</span><span class="n">DataGrabber</span><span class="p">(</span>
        <span class="n">infields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;subject_id&#39;</span><span class="p">],</span> <span class="n">outfields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="s1">&#39;struct&#39;</span><span class="p">]),</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;datasource&#39;</span><span class="p">)</span>
<span class="n">datasource</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">base_directory</span> <span class="o">=</span> <span class="n">data_dir</span>
<span class="n">datasource</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.nii&#39;</span>
<span class="n">datasource</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">template_args</span> <span class="o">=</span> <span class="n">info</span>
<span class="n">datasource</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">sort_filelist</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
<p>Use the get_node function to retrieve an internal node by name. Then set the
iterables on this node to perform two different extents of smoothing.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">smoothnode</span> <span class="o">=</span> <span class="n">firstlevel</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="s1">&#39;preproc.smooth&#39;</span><span class="p">)</span>
<span class="k">assert</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">smoothnode</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;preproc.smooth&#39;</span><span class="p">)</span>
<span class="n">smoothnode</span><span class="o">.</span><span class="n">iterables</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;fwhm&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">5.</span><span class="p">,</span> <span class="mf">10.</span><span class="p">])</span>

<span class="n">hpcutoff</span> <span class="o">=</span> <span class="mi">120</span>
<span class="n">TR</span> <span class="o">=</span> <span class="mf">3.</span>  <span class="c1"># ensure float</span>
<span class="n">firstlevel</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">preproc</span><span class="o">.</span><span class="n">highpass</span><span class="o">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="s1">&#39;_hpf&#39;</span>
<span class="n">firstlevel</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">preproc</span><span class="o">.</span><span class="n">highpass</span><span class="o">.</span><span class="n">op_string</span> <span class="o">=</span> <span class="s1">&#39;-bptf </span><span class="si">%d</span><span class="s1"> -1&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hpcutoff</span> <span class="o">/</span> <span class="n">TR</span><span class="p">)</span>
</pre></div>
</div>
<p>Setup a function that returns subject-specific information about the
experimental paradigm. This is used by the
<code class="xref py py-class docutils literal notranslate"><span class="pre">nipype.interfaces.spm.SpecifyModel</span></code> to create the information necessary
to generate an SPM design matrix. In this tutorial, the same paradigm was used
for every participant. Other examples of this function are available in the
<cite>doc/examples</cite> folder. Note: Python knowledge required here.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">subjectinfo</span><span class="p">(</span><span class="n">subject_id</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">nipype.interfaces.base</span> <span class="k">import</span> <span class="n">Bunch</span>
    <span class="kn">from</span> <span class="nn">copy</span> <span class="k">import</span> <span class="n">deepcopy</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Subject ID: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">subject_id</span><span class="p">))</span>
    <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Task-Odd&#39;</span><span class="p">,</span> <span class="s1">&#39;Task-Even&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">onsets</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="mi">60</span><span class="p">)),</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">45</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="mi">60</span><span class="p">))]</span>
        <span class="n">output</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">r</span><span class="p">,</span>
                      <span class="n">Bunch</span><span class="p">(</span>
                          <span class="n">conditions</span><span class="o">=</span><span class="n">names</span><span class="p">,</span>
                          <span class="n">onsets</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">onsets</span><span class="p">),</span>
                          <span class="n">durations</span><span class="o">=</span><span class="p">[[</span><span class="mi">15</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">names</span><span class="p">],</span>
                          <span class="n">amplitudes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">tmod</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">pmod</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">regressor_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">regressors</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">output</span>
</pre></div>
</div>
<p>Setup the contrast structure that needs to be evaluated. This is a list of
lists. The inner list specifies the contrasts and has the following format -
[Name,Stat,[list of condition names],[weights on those conditions]. The
condition names must match the <cite>names</cite> listed in the <cite>subjectinfo</cite> function
described above.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cont1</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Task&gt;Baseline&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;Task-Odd&#39;</span><span class="p">,</span> <span class="s1">&#39;Task-Even&#39;</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]]</span>
<span class="n">cont2</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Task-Odd&gt;Task-Even&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;Task-Odd&#39;</span><span class="p">,</span> <span class="s1">&#39;Task-Even&#39;</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
<span class="n">cont3</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Task&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">cont1</span><span class="p">,</span> <span class="n">cont2</span><span class="p">]]</span>
<span class="n">contrasts</span> <span class="o">=</span> <span class="p">[</span><span class="n">cont1</span><span class="p">,</span> <span class="n">cont2</span><span class="p">]</span>

<span class="n">firstlevel</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">modelfit</span><span class="o">.</span><span class="n">modelspec</span><span class="o">.</span><span class="n">input_units</span> <span class="o">=</span> <span class="s1">&#39;secs&#39;</span>
<span class="n">firstlevel</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">modelfit</span><span class="o">.</span><span class="n">modelspec</span><span class="o">.</span><span class="n">time_repetition</span> <span class="o">=</span> <span class="n">TR</span>
<span class="n">firstlevel</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">modelfit</span><span class="o">.</span><span class="n">modelspec</span><span class="o">.</span><span class="n">high_pass_filter_cutoff</span> <span class="o">=</span> <span class="n">hpcutoff</span>

<span class="n">firstlevel</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">modelfit</span><span class="o">.</span><span class="n">level1design</span><span class="o">.</span><span class="n">interscan_interval</span> <span class="o">=</span> <span class="n">TR</span>
<span class="n">firstlevel</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">modelfit</span><span class="o">.</span><span class="n">level1design</span><span class="o">.</span><span class="n">bases</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dgamma&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;derivs&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}}</span>
<span class="n">firstlevel</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">modelfit</span><span class="o">.</span><span class="n">level1design</span><span class="o">.</span><span class="n">contrasts</span> <span class="o">=</span> <span class="n">contrasts</span>
<span class="n">firstlevel</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">modelfit</span><span class="o">.</span><span class="n">level1design</span><span class="o">.</span><span class="n">model_serial_correlations</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
<div class="section" id="set-up-complete-workflow">
<h3>Set up complete workflow<a class="headerlink" href="#set-up-complete-workflow" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">l1pipeline</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;level1&quot;</span><span class="p">)</span>
<span class="n">l1pipeline</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;./fsl/workingdir&#39;</span><span class="p">)</span>
<span class="n">l1pipeline</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;execution&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;crashdump_dir&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;./fsl/crashdumps&#39;</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">l1pipeline</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
    <span class="p">(</span><span class="n">infosource</span><span class="p">,</span> <span class="n">datasource</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;subject_id&#39;</span><span class="p">)]),</span>
    <span class="p">(</span><span class="n">infosource</span><span class="p">,</span> <span class="n">firstlevel</span><span class="p">,</span> <span class="p">[((</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="n">subjectinfo</span><span class="p">),</span>
                               <span class="s1">&#39;modelfit.modelspec.subject_info&#39;</span><span class="p">)]),</span>
    <span class="p">(</span><span class="n">datasource</span><span class="p">,</span> <span class="n">firstlevel</span><span class="p">,</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;struct&#39;</span><span class="p">,</span> <span class="s1">&#39;preproc.inputspec.struct&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="s1">&#39;preproc.inputspec.func&#39;</span><span class="p">),</span>
    <span class="p">]),</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="execute-the-pipeline">
<h2>Execute the pipeline<a class="headerlink" href="#execute-the-pipeline" title="Permalink to this headline">¶</a></h2>
<p>The code discussed above sets up all the necessary data structures with
appropriate parameters and the connectivity between the processes, but does not
generate any output. To actually run the analysis on the data the
<code class="docutils literal notranslate"><span class="pre">nipype.pipeline.engine.Pipeline.Run</span></code> function needs to be called.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">l1pipeline</span><span class="o">.</span><span class="n">write_graph</span><span class="p">()</span>
    <span class="n">outgraph</span> <span class="o">=</span> <span class="n">l1pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="c1"># l1pipeline.run(plugin=&#39;MultiProc&#39;, plugin_args={&#39;n_procs&#39;:2})</span>
</pre></div>
</div>
<div class="admonition-example-source-code admonition">
<p class="first admonition-title">Example source code</p>
<p class="last">You can download <a class="reference download internal" download="" href="../../_downloads/3ce90bd6e913e2fea7e7d4dcae81158d/fmri_fsl.py"><code class="xref download docutils literal notranslate"><span class="pre">the</span> <span class="pre">full</span> <span class="pre">source</span> <span class="pre">code</span> <span class="pre">of</span> <span class="pre">this</span> <span class="pre">example</span></code></a>.
This same script is also included in the Nipype source distribution under the
<code class="file docutils literal notranslate"><span class="pre">examples</span></code> directory.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2009-18, Neuroimaging in Python team.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.1.
    </div>
<div class="footer">This page uses <a href="http://analytics.google.com/">
Google Analytics</a> to collect statistics. You can disable it by blocking
the JavaScript coming from www.google-analytics.com.
</div>

  </body>
</html>